<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stromampel</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .traffic-light {
            width: 200px;
            background-color: #333;
            border-radius: 10px;
            padding: 10px;
        }
        .light {
            width: 160px;
            height: 160px;
            border-radius: 50%;
            margin: 10px auto;
            opacity: 0.3;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            color: #333;
        }
        .red { background-color: red; }
        .yellow { background-color: yellow; }
        .green { background-color: green; }
        .active { opacity: 1; }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h1 id="stromampel" class="mb-4 text-center">CO<sub>2</sub>-Ampel </h1>
        <h2 id="" class="mb-4 text-center">für Strom in <span id="city"></span></h2>
        <div class="row justify-content-center">
            <div class="col-md-4">
                <div id="trafficLight" class="traffic-light mb-3">
                    <div id="redLight" class="light red"></div>
                    <div id="yellowLight" class="light yellow"></div>
                    <div id="greenLight" class="light green"></div>
                </div>
            </div>
        </div>

        <div class="row mt-4 justify-content-center">
            <div class="col-md-6">
                <button id="getLocationBtn" class="btn btn-primary mb-3">Standort ermitteln</button>
                <button id="enterAddressBtn" class="btn btn-secondary mb-3 ms-2">Standort eingeben</button>
                <div id="addressInputContainer" class="mb-3" style="display: none;">
                    <input type="text" id="addressInput" class="form-control" placeholder="Adresse oder PLZ eingeben">
                    <button id="submitAddress" class="btn btn-primary mt-2">Absenden</button>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-12">
                <h2>Stundenübersicht</h2>
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Uhrzeit</th>
                                <th>Ampelfarbe</th>
                                <th>CO<sub>2</sub></th>
                            </tr>
                        </thead>
                        <tbody id="hourlyForecast"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const trafficLight = document.getElementById('trafficLight');
        const redLight = document.getElementById('redLight');
        const yellowLight = document.getElementById('yellowLight');
        const greenLight = document.getElementById('greenLight');
        const hourlyForecast = document.getElementById('hourlyForecast');
        const getLocationBtn = document.getElementById('getLocationBtn');
        const enterAddressBtn = document.getElementById('enterAddressBtn');
        const addressInputContainer = document.getElementById('addressInputContainer');
        const addressInput = document.getElementById('addressInput');
        const submitAddress = document.getElementById('submitAddress');

        function setTrafficLight(color,co2) {
            redLight.title = "";
            yellowLight.title = "";
            greenLight.title = "";
            redLight.classList.remove('active');
            yellowLight.classList.remove('active');
            greenLight.classList.remove('active');
            if (color === 'red') {
                redLight.classList.add('active');
                redLight.title = co2 + "g/kWh";
            } else if (color === 'yellow') {
                yellowLight.classList.add('active');
                yellowLight.title = co2 + "g/kWh";
            } else if (color === 'green') {
                greenLight.classList.add('active');
                greenLight.title = co2 + "g/kWh";
            }
        }

        function updateHourlyForecast(data) {
            hourlyForecast.innerHTML = '';
            data.data.forEach(hour => {
                const row = document.createElement('tr');
                const timeCell = document.createElement('td');
                const colorCell = document.createElement('td');
                const emissionCell = document.createElement('td');

                const date = new Date(hour.time * 1);
                timeCell.textContent = date.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
                colorCell.textContent = hour.advice == "green" ? 'Grün' : hour.advice == 'yellow' ? 'Gelb' : 'Rot';
                emissionCell.textContent = hour.co2 + "g";
                row.appendChild(timeCell);
                row.appendChild(colorCell);
                row.appendChild(emissionCell);
                hourlyForecast.appendChild(row);
            });
        }

        async function fetchData(url) {
            try {
                const response = await fetch(url);
                const data = await response.json();
                setTrafficLight(data.data[0].advice,data.data[0].co2);
                redLight.innerHTML = "&gt;" + data.tresholds.red.low + "g";
                yellowLight.innerHTML =  "";
                greenLight.innerHTML = "&lt;" + data.tresholds.green.high + "g";

                updateHourlyForecast(data);
                city.innerText = data.location.city;
            } catch (error) {
                console.error('Error fetching data:', error);
            }
        }

        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    position => {
                        const { latitude, longitude } = position.coords;
                        fetchData(`https://api.corrently.io/v2.0/gsi/best?lat=${latitude}&lon=${longitude}`);
                    },
                    error => {
                        console.error('Error getting location:', error);
                        showAddressInput();
                        getLocationBtn.style.display = 'none';
                        enterAddressBtn.style.display = 'none';
                    }
                );
            } else {
                console.error('Geolocation is not supported by this browser.');
                showAddressInput();
            }
        }

        function showAddressInput() {
            addressInputContainer.style.display = 'block';
        }

        getLocationBtn.addEventListener('click', getLocation);
        enterAddressBtn.addEventListener('click', showAddressInput);

        submitAddress.addEventListener('click', () => {
            const query = addressInput.value.trim();
            if (query) {
                fetchData(`https://api.corrently.io/v2.0/gsi/advisor?q=${encodeURIComponent(query)}`);
            }
        });

        // Initially try to get the location
        getLocation();
    </script>
</body>
</html>